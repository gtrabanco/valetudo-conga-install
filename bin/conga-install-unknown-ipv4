#!/usr/bin/env bash
#shellcheck disable=SC2207,SC1091

SCRIPT_BIN_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
SCRIPT_PATH="$(dirname "$SCRIPT_BIN_PATH")"
SCRIPT_LIB_PATH="${SCRIPT_PATH}/lib"

if ! echo ":$PATH:" | grep -q ":$SCRIPT_BIN_PATH:"; then
  PATH="${PATH:+${SCRIPT_BIN_PATH}:${PATH}}"
fi

. "${SCRIPT_LIB_PATH}/core.sh"
. "${SCRIPT_LIB_PATH}/ssh.sh"
. "${SCRIPT_LIB_PATH}/log.sh"

depends_on ifconfig awk cut grep

GET_ALL_NET_IPS=(
  $(ifconfig | awk '/inet [0-9\.]+/ {print $2}' | cut -d. -f1-3 | grep -v '127.0.0')
)
# RANGE="1-254"

if [ ${#GET_ALL_NET_IPS[@]} -eq 0 ]; then
  echo "No network IPs found"
  exit 1
fi

for ip in "${GET_ALL_NET_IPS[@]}"; do
  [ -z "${:-}" ] && continue

  echo
  echo "Scanning the range ${ip}.1-255"
  # begin solution using nmap #
  # GET_ALL_CONGA_IPS=(
  #   $(nmap -Pn -p 22,53,6000 "${ip}.${RANGE}" -oG - | awk '#/open/# { print $2 }')
  # )
  # [ ${#GET_ALL_CONGA_IPS[@]} -eq 0 ] && continue
  # echo "Checking which is the ip address of your conga"
  # for conga_ip in "${GET_ALL_CONGA_IPS[@]}"; do
  # end of using nmap #
  for octect in {1..254}; do
    ! test_ssh_connection "${ip}.${octect}" 22 && continue
    conga_ip="${ip}.${octect}"
    ! "${SCRIPT_BIN_PATH}/conga-install-ssh" "${conga_ip}" &> /dev/null &&
      continue

    echo "GOOD NEWS! A conga was found!"
    echo "Conga ip address: ${conga_ip}"
    echo "Your ssh key was installed correctly in your conga you can access without password"
    echo

    echo "Installing valetudo, this will take a very long time... Could take more than 30 minutes... Be patient."
    "${SCRIPT_BIN_PATH}/conga-install-valetudo" "${conga_ip}" || echo && echo "Failed to install valetudo" && exit 1

    # Wait for conga to reboot...
    command -v "open" &> /dev/null && sleep 30s && open "http://${conga_ip}"

    echo "Successfully installed valetudo!"
    echo "Wait for conga to reboot & you can acces to end the configuration on the gui to:"
    echo "http://${conga_ip}"
    echo
  done
done

echo "No conga was found"
exit 1
