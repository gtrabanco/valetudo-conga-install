#!/usr/bin/expect -f
set user [lindex $argv 0]
set server [lindex $argv 1]
set port [lindex $argv 2]
set passwd [lindex $argv 3]

send_user "Connecting to ${server}:${port} with password: $passwd \n"

set try 0
spawn ssh-copy-id -f -p $port -o PreferredAuthentications=password -o PubkeyAuthentication=no "${user}@${server}"
match_max 100000
expect {
  "*(yes/no/?fingerprint?)*" {
    send "yes\r"
  }

  "*?assword:*" {
    if { $try > 0 } {
      send_user "Too many tries\n"
      exit 1
    }

    incr try
    send -- "$passwd\r"
    send -- "\r"
    expect {
      "*Number of key(s) added: 1*" { exit 0 }
      "*ermission denied*" { exit 1 }
    }

    expect eof { exit 0 }
  }
}
exit 1
